models:
  - name: customers
    description: "Customer overview data mart, offering key details for each unique customer. One row per customer.Customer overview data mart, offering key details for each unique customer. One row per customer.Customer grain mart.\n"
    data_tests:
      - dbt_utils.expression_is_true:
          expression: "lifetime_spend_pretax + lifetime_tax_paid = lifetime_spend"
    columns:
      - name: customer_id
        description: The unique key of the orders mart.
        data_tests:
          - not_null
          - unique
        entity:
          type: primary
          name: customer
      - name: customer_name
        description: Customers' full name.
        dimension:
          type: categorical
      - name: count_lifetime_orders
        description: Total number of orders a customer has ever placed.
      - name: first_ordered_at
        description: The timestamp when a customer placed their first order.
        dimension:
          type: time
        granularity: day
      - name: last_ordered_at
        description: The timestamp of a customer's most recent order.
        dimension:
          type: time
        granularity: day
      - name: lifetime_spend_pretax
        description: The sum of all the pre-tax subtotals of every order a customer has placed.
      - name: lifetime_tax_paid
        description: The sum of all the tax portion of every order a customer has placed.
      - name: lifetime_spend
        description: The sum of all the order totals (including tax) that a customer has ever placed.
      - name: customer_type
        description: Options are 'new' or 'returning', indicating if a customer has ordered more than once or has only placed their first order to date.
        data_tests:
          - accepted_values:
              values: ["new", "returning"]

        dimension:
          type: categorical
    semantic_model:
      enabled: true
    agg_time_dimension: first_ordered_at
    metrics:
      - name: customers
        type: simple
        label: customers
        hidden: true
        description: Count of unique customers
        agg: count_distinct
      - name: count_lifetime_orders
        type: simple
        label: Count Lifetime Orders
        description: Total count of orders per customer.
        agg: sum
      - name: lifetime_spend_pretax
        type: simple
        label: LTV Pre-tax
        description: Customer lifetime spend before taxes.
        agg: sum
      - name: lifetime_spend
        type: simple
        label: lifetime_spend
        agg: sum
        description: Gross customer lifetime spend inclusive of taxes.
      - name: average_order_value
        description: LTV pre-tax / number of orders
        label: Average Order Value
        type: derived
        expr: lifetime_spend_pretax / count_lifetime_orders
        input_metrics:
          - count_lifetime_orders
          - lifetime_spend_pretax

saved_queries:
  - name: customer_order_metrics
    query_params:
      metrics:
        - count_lifetime_orders
        - lifetime_spend_pretax
        - average_order_value
      group_by:
        - Entity('customer')
    exports:
      - name: customer_order_metrics
        config:
          export_as: table